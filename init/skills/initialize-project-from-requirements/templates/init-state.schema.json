{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "Init State",
  "description": "Tracks the progress of the 3-stage initialization workflow.",
  "type": "object",
  "additionalProperties": false,
  "required": [
    "version",
    "stage",
    "createdAt",
    "stage-a",
    "stage-b",
    "stage-c",
    "history"
  ],
  "properties": {
    "version": {
      "type": "integer",
      "const": 1
    },
    "stage": {
      "type": "string",
      "enum": ["A", "B", "C", "complete"],
      "description": "Current stage of initialization"
    },
    "createdAt": {
      "type": "string",
      "format": "date-time",
      "description": "State file creation time (ISO 8601)"
    },
    "stage-a": {
      "type": "object",
      "description": "Stage A: Requirements interview progress",
      "additionalProperties": false,
      "required": ["mustAsk", "docsWritten", "validated", "userApproved"],
      "properties": {
        "mustAsk": {
          "type": "object",
          "description": "MUST-ask question tracking (optional to keep up to date manually).",
          "additionalProperties": false,
          "required": [
            "onePurpose",
            "userRoles",
            "mustRequirements",
            "outOfScope",
            "userJourneys",
            "constraints",
            "successMetrics"
          ],
          "properties": {
            "onePurpose": { "$ref": "#/$defs/questionState" },
            "userRoles": { "$ref": "#/$defs/questionState" },
            "mustRequirements": { "$ref": "#/$defs/questionState" },
            "outOfScope": { "$ref": "#/$defs/questionState" },
            "userJourneys": { "$ref": "#/$defs/questionState" },
            "constraints": { "$ref": "#/$defs/questionState" },
            "successMetrics": { "$ref": "#/$defs/questionState" }
          }
        },
        "docsWritten": {
          "type": "object",
          "description": "Stage A doc files present (auto-updated when `check-docs` passes)",
          "additionalProperties": false,
          "required": ["requirements", "nfr", "glossary", "riskQuestions"],
          "properties": {
            "requirements": { "type": "boolean" },
            "nfr": { "type": "boolean" },
            "glossary": { "type": "boolean" },
            "riskQuestions": { "type": "boolean" }
          }
        },
        "validated": {
          "type": "boolean",
          "description": "`check-docs` passed"
        },
        "userApproved": {
          "type": "boolean",
          "description": "User explicitly approved Stage A outputs"
        }
      }
    },
    "stage-b": {
      "type": "object",
      "description": "Stage B: Blueprint generation progress",
      "additionalProperties": false,
      "required": ["drafted", "validated", "packsReviewed", "userApproved"],
      "properties": {
        "drafted": { "type": "boolean" },
        "validated": { "type": "boolean" },
        "packsReviewed": { "type": "boolean" },
        "userApproved": { "type": "boolean" }
      }
    },
    "stage-c": {
      "type": "object",
      "description": "Stage C: Scaffold and skills",
      "additionalProperties": false,
      "required": [
        "scaffoldApplied",
        "configsGenerated",
        "manifestUpdated",
        "wrappersSynced",
        "skillRetentionReviewed",
        "userApproved"
      ],
      "properties": {
        "scaffoldApplied": { "type": "boolean" },
        "configsGenerated": { "type": "boolean" },
        "manifestUpdated": { "type": "boolean" },
        "wrappersSynced": { "type": "boolean" },
        "skillRetentionReviewed": { "type": "boolean" },
        "userApproved": { "type": "boolean" }
      }
    },
    "history": {
      "type": "array",
      "description": "Audit trail of stage transitions and validations.",
      "items": { "$ref": "#/$defs/historyEvent" }
    }
  },
  "$defs": {
    "questionState": {
      "type": "object",
      "additionalProperties": false,
      "required": ["asked", "answered", "writtenTo"],
      "properties": {
        "asked": { "type": "boolean" },
        "answered": { "type": "boolean" },
        "writtenTo": {
          "type": ["string", "null"],
          "description": "Doc file path that received the answer (or null if not written)."
        }
      }
    },
    "historyEvent": {
      "type": "object",
      "additionalProperties": false,
      "required": ["timestamp", "event", "details"],
      "properties": {
        "timestamp": { "type": "string", "format": "date-time" },
        "event": { "type": "string" },
        "details": { "type": "string" }
      }
    }
  }
}
